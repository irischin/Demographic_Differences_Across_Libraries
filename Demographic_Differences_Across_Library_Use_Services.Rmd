---
title: "Community Differences in Library Use and Services"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here I'll be detailing the analyses I performed to investigate how a library's services can differ depending on its surrounding community's demographic makeup as well as how different demographic communities might vary in their use of library resources. For this particular set of analyses, I'll be focusing on libraries located in cities; follow-up work will be done on libraries located in other locales (e.g., rural areas, suburbs, etc.).

To generate the appropriate dataset needed for the following analyses, I used information spread across four datasets: (1) **The Public Library Survey** collected for the year 2012 that provides information about libraries' services, collections, etc.; (2) **US 2010 Decennial Census data**; (3) List of **zip codes and the corresponding Zip Code Tabulation Area (ZCTA)**; (4) List of **Zip Code Tabulation Areas (ZCTA) and their corresponding longitudinal and latitude information**. For more information on each of those datasets and how I created the dataset for the current analyses, please see the `Creating_dataset` R-markdown file. 

In short, the dataset that I created involves the original Public Library Survey 2012 dataset combined with information about the majority race/ethnicity of the community surrounding each library. "Community" here is defined as any area that falls within a 2 mile radius of a library. This is not to say that libraries only service the population that is located within a 2 mile radius. However, a cut-off was needed and 2 miles did not appear to be completely unreasonable given that in cities, libraries are typically more clustered in comparison to libraries located in other locales (e.g., rural areas). Suggestions for what may be a better cut-off is welcomed! 

First to load all the necessary packages:
```{r, load packages, message=F, warning=F}
library(dplyr)
library(reshape2)
library(ggplot2)
library(grid)
library(gridExtra)
library(car)
library(dunn.test)
```

Next, the dataset we'll be using:
```{r, load dataset}
lib_2012s<-read.table("lib_2012_and_demo.txt", sep="\t", header=T)
```

#Do the total number of annual visits and registered users differ by the demographic of a library's community?

Here, we'll look at number of annual visits per capita (i.e., based on the population of legal service area).

```{r annual visits}
lib_2012_visits<-lib_2012s %>%
  mutate(Visits_prop=VISITS/POPU_UND) %>%
  filter(Majority_demo!="NH_Asian") %>%
  mutate(Majority_demo=factor(Majority_demo, labels=c("Hispanic", "Black, Non-Hispanic", "White, Non-Hispanic"))) %>%
  select(Visits_prop, Majority_demo)
```

We can then use a non-parametric test (i.e., Kruskal Wallis Test) to determine if libraries located in majority Hispanic, White, Non-Hispanic, and Black, Non-Hispanic communities differ in the total number of annual visits to the library. A non-parametric test is used rather than an one-way ANOVA because preliminary work revealed that some assumptions of ANOVA were violated here (e.g., variance of the demographic groups differed significantly based on Levene's Test).
```{r group differences in visits}
kruskal.test(Visits_prop~Majority_demo, lib_2012_visits)
with(lib_2012_visits, dunn.test(Visits_prop, Majority_demo, kw=F, method="bonferroni"))
```

From this, we can see that the three communities differed significantly from each other, with libraries in White, Non-Hispanic majority communities having the highest mean rank of annual visits per capita (*M* = 270.31), followed by libraries in Black, Non-Hispanic majority communities (*M* = 215.03), and finally libraries in Hispanic majority communities (*M* = 142.76).

We can then look at the number of annual registered users per capita:
```{r registered users}
lib_2012_reg<-lib_2012s %>%
  mutate(Reg_prop=REGBOR/POPU_UND) %>%
  filter(Majority_demo!="NH_Asian") %>%
  mutate(Majority_demo=factor(Majority_demo, labels=c("Hispanic", "Black, Non-Hispanic", "White, Non-Hispanic"))) %>%
  select(Reg_prop, Majority_demo)
```

Again, using the Kruskal Wallis Test, we find that the communities differ significantly in their number of annual registered users per capita. However, a pattern slightly different from the annual visits emerged here. Libraries in communities with a Hispanic majority (*M* = 181.37) differed significantly from libraries in communities with a White majority (*M* = 260.80) in their mean rank of annual registered users per capita. However, libraries in Hispanic and Black majority communities (*M* = 227.54) did not differ significantly; Libraries in Black majority communities also did not differ significantly from those in White majority communities.
```{r}
kruskal.test(Reg_prop~Majority_demo, lib_2012_reg)
with(lib_2012_reg, dunn.test(Reg_prop, Majority_demo, kw=F, method="bonferroni"))
```

We can also graph both annual visits and annual registered users:
```{r Annual Visits and Registered Users Graph, echo=FALSE, fig.align='center', dpi=500}
cbPalette <- c("#1b9e77", "#d95f02", "#7570b3")

lib_2012_visits_graph<-lib_2012_visits %>%
  group_by(Majority_demo) %>%
  summarise(Visits=mean(Visits_prop), 
            Visits_SD=sd(Visits_prop), 
            Visits_SE=sd(Visits_prop)/sqrt(length(Visits_prop))) %>%
  ggplot(aes(x=Majority_demo, y=Visits, fill=Majority_demo))+
  geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=Visits-Visits_SE, ymax=Visits+Visits_SE), width=.2, position=position_dodge(.75))+
  scale_fill_manual(values=cbPalette)+
  scale_x_discrete(labels=c("Hispanic","Black\nNon-Hispanic","White\nNon-Hispanic"))+
  ylim(0, 10)+
  ylab("Average Number of Visits Per Capita ")+
  xlab("Race/Ethnicity")+
  theme_bw() +
  theme(legend.position = "none")+
  geom_text(
    aes(label = round(Visits, 3), group=Majority_demo, y=Visits+Visits_SE), 
    vjust=-1.5,
    position = position_dodge(0.90),
    size=3, colour="black", show.legend = F)

lib_2012_reg_graph<-lib_2012_reg %>%
  group_by(Majority_demo) %>%
  summarise(Registered_users=mean(Reg_prop),
            Reg_users_SD=sd(Reg_prop), 
            Reg_users_SE=sd(Reg_prop)/sqrt(length(Reg_prop))) %>%
  ggplot(aes(x=Majority_demo, y=Registered_users, fill=Majority_demo))+
  geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=Registered_users-Reg_users_SE, ymax=Registered_users+Reg_users_SE), width=.2, position=position_dodge(.75)) +
  scale_fill_manual(values=cbPalette)+
  scale_x_discrete(labels=c("Hispanic","Black\nNon-Hispanic","White\nNon-Hispanic"))+
  ylim(0, 1.0)+
  ylab("Average Number of Registered Users Per Capita")+
  xlab("Race/Ethnicity")+
  theme_bw() +
  theme(legend.position = "none")+
  geom_text(
    aes(label = round(Registered_users, 3), group=Majority_demo, y=Registered_users+Reg_users_SE), 
    vjust=-1.5,
    position = position_dodge(0.90),
    size=3, colour="black", show.legend = F)

title<-"A library's use depends on its community's racial/ethnic demographics"
title<-paste0(strwrap(title, 75), sep="", collapse="\n")

caption<-"Note: All three demographic community groups differed significantly from each other in the number of annual visits per capita. However, only libraries with majority Hispanic surrounding communities had fewer number of registered users per capita compared to libraries with majority White surrounding communities. There were no other significant differences in annual registered users among the three community types."
caption<-paste0(strwrap(caption, 115), sep="", collapse="\n")

grid.arrange(lib_2012_visits_graph, lib_2012_reg_graph, ncol=2,
             top=textGrob(paste(title),
                          x=0.06,
                          y=0.5,
                          just="left",
                          gp=gpar(fontsize=13, fontface="bold")),
             bottom=textGrob(caption,
                             x=0.05,
                             y=0.5,
                             just="left",
                             gp=gpar(fontsize=9)))
```

#Does the library's collection vary by the demographic of a library's community?
Additionally, given the rise of digital content, a question of interest might be whether libraries provide similar amount of digital content across communities? 

To account for different sizes of the libraries, we'll look at the size of different collection types per capita.
```{r lib_collection, warning=FALSE, message=FALSE}
lib_2012_collection<-lib_2012s %>%
  select(POPU_UND, BKVOL, EBOOK, AUDIO_PH, AUDIO_DL, VIDEO_PH, VIDEO_DL, DATABASE, Majority_demo) %>%
  mutate_each(funs(replace(., .<0, NA))) %>%
  filter(Majority_demo!="NH_Asian") %>%
  mutate(Majority_demo=factor(Majority_demo, labels=c("Hispanic", "Black, Non-Hispanic", "White, Non-Hispanic"))) %>%
  mutate(Books=BKVOL/POPU_UND, Ebooks=EBOOK/POPU_UND,
         Audio_PH=AUDIO_PH/POPU_UND, Audio_DL=AUDIO_DL/POPU_UND,
         Video_PH=VIDEO_PH/POPU_UND, Video_DL=VIDEO_DL/POPU_UND,
         Database=DATABASE/POPU_UND) %>%
  select(Books, Ebooks, Audio_PH, Audio_DL,  Video_PH, Video_DL, Database, Majority_demo)
```

Given our dataset and questions, a MANOVA might be the statistical test to use. However, because some assumptions were violated here (e.g., lack of linear relationship between DVs within each IV, unequal variances, etc.), performing a MANOVA is not actually appropriate. Thus, I ended up running multiple Kruskal-Wallis tests instead. However, instead of running six individual tests, I collapsed Audio and Video (physical) collections into one category and Audio and Video (digital) collections into another category. Additionally, because I ran four Kruskal-Wallis tests, I used the adjusted alpha of 0.0125.
```{r}
kruskal.test(Books~Majority_demo, lib_2012_collection)
with(lib_2012_collection, dunn.test(Books, Majority_demo, kw=F, method="bonferroni"))

kruskal.test(Ebooks~Majority_demo, lib_2012_collection)
with(lib_2012_collection, dunn.test(Ebooks, Majority_demo, kw=F, method="bonferroni"))

kruskal.test((Audio_PH+Video_PH)~Majority_demo, lib_2012_collection)
with(lib_2012_collection, dunn.test((Audio_PH+Video_PH), Majority_demo, kw=F, method="bonferroni"))

kruskal.test((Audio_DL+Video_DL)~Majority_demo, lib_2012_collection)
with(lib_2012_collection, dunn.test((Audio_DL+Video_DL), Majority_demo, kw=F, method="bonferroni"))
```
With physical print materials, libraries in communities with majority Hispanic members (*M* = 136.76) had a significantly lower mean rank of physical print materials compared to libraries in communities with majority Black (*M* = 248.44) and with majority White (*M* = 265.58) members.

With Ebooks, libraries in communities with majority White members (*M* = 267.23) had significantly higher mean rank of physical print materials compared to libraries in communities with majority Black (*M* = 208.31) and with majority Hispanic (*M* = 165.24) members.

With physical audio and video content, communities differed significantly from each other. Libraries in communities with majority White members (*M* = 271.65) had the highest mean rank of such content, followed by libraries in communities with majority Black members (*M* = 208.19), then libraries in communities with majority Hispanic members (*M* = 142.00). 

With digital audio and video content, libraries in communities with majority White members (*M* = 264.53) had a significantly higher mean rank of such content than libraries in communities with majority Black (*M* = 200.14) and with majority Hispanic members (*M* = 187.04).  

We can also graph this:
```{r Collections graph, echo=F, fig.align='center', dpi=500}
lib_2012_collection_sum<-lib_2012_collection %>%
  mutate(Other_PH=Audio_PH+Video_PH, Other_DL=Audio_DL+Video_DL) %>%
  group_by(Majority_demo) %>%
  select(Books, Ebooks, Other_PH, Other_DL, Majority_demo) %>%
  summarise(Books_mean=mean(Books, na.rm=T), Books_SD=sd(Books, na.rm=T), 
            Books_SE=sd(Books, na.rm=T)/sqrt(sum(!is.na(Books))),
            
            Ebooks_mean=mean(Ebooks, na.rm=T), Ebooks_SD=sd(Ebooks, na.rm=T), 
            Ebooks_SE=sd(Ebooks, na.rm=T)/sqrt(sum(!is.na(Ebooks))),
            
            Other_PH_mean=mean(Other_PH, na.rm=T), Other_PH_SD=sd(Other_PH, na.rm=T),
            Other_PH_SE=sd(Other_PH, na.rm=T)/sqrt(sum(!is.na(Other_PH))),
            
            Other_DL_mean=mean(Other_DL, na.rm=T), Other_DL_SD=sd(Other_DL, na.rm=T),
            Other_DL_SE=sd(Other_DL, na.rm=T)/sqrt(sum(!is.na(Other_DL)))
            )

lib_2012_collection_mean<-melt(lib_2012_collection_sum[,c("Majority_demo", "Books_mean", "Ebooks_mean", "Other_PH_mean", "Other_DL_mean")], id.vars = "Majority_demo", variable.name = "Collection")
names(lib_2012_collection_mean)[3]<-"Mean"

lib_2012_collection_se<-melt(lib_2012_collection_sum[,c("Majority_demo", "Books_SE", "Ebooks_SE", "Other_PH_SE", "Other_DL_SE")], id.vars = "Majority_demo", variable.name = "Collection") 

lib_2012_collection_mean$SE<-lib_2012_collection_se[,3]

collection_title<-"A library's collection size varies based on its community's racial/ethnic demographics"
collection_title<-paste0(strwrap(collection_title, 75), sep="", collapse="\n")

collection_caption<-"Note: Libraries located in communities with majority White members typically have larger collections, regardless of whether the content/material is physical or digital. Libraries located in communities with majority Black members and in communities with majority Hispanic members did not differ in their collection size, with the exception of physical materials (i.e., print, video, and audio)."
collection_caption<-paste0(strwrap(collection_caption, 110), sep="", collapse="\n")

lib_2012_collection_mean %>%
  ggplot(aes(x=Majority_demo, y=Mean, fill=Majority_demo))+
  geom_bar(stat="identity", position="dodge", aes(alpha=Collection)) +
  scale_fill_manual(values=cbPalette)+
  scale_alpha_manual(values=c(0.30, 0.5, 0.75, 1), name="Material Type", labels=c("Print Material", "Ebooks", "Other Media (Physical)", "Other Media (Digital)")) +
  geom_errorbar(aes(ymin=Mean-SE, ymax=Mean+SE, group=Collection), width=.2, position=position_dodge(.9)) +
  labs(x="Race/Ethnicity",
       y="Average Number of Material Type Per Capita", 
       title=collection_title,
       caption=collection_caption)+
  theme_bw() +
  theme(plot.title=element_text(size = 13, face = "bold"),
        plot.caption = element_text(size=9, hjust=0)) +
  guides(fill=FALSE)+
  geom_text(
    aes(label = round(Mean, 3), group=Collection, y=Mean+SE/1.5), 
    vjust=-1.5,
    position = position_dodge(0.90),
    size=2.5, colour="black", show.legend = F)
```

#Do the library services used by members of a community differ depending on its demographics?

For this, we'll look at (1) total annual circulation transactions, (2) total audience at programs, (3) total reference transactions, and (4) total uses of public internet computers. To take into account the differing sizes of libraries, we'll look at these variables out of the total annual number of visits.
```{r services}
lib_2012_services<-lib_2012s %>%
  mutate(Cir=TOTCIR/VISITS, Prog_attend=TOTATTEN/VISITS, Reference=REFERENC/VISITS, Pub_Internet=PITUSR/VISITS) %>%
  filter(Majority_demo!="NH_Asian") %>%
  mutate(Majority_demo=factor(Majority_demo, labels=c("Hispanic", "Black, Non-Hispanic", "White, Non-Hispanic"))) %>%
  select(Majority_demo, Cir, Prog_attend, Reference, Pub_Internet) 

#to compare total annual circulation transactions across communities
kruskal.test(Cir~Majority_demo, lib_2012_services)
with(lib_2012_services, dunn.test(Cir, Majority_demo, kw=F, method="bonferroni"))

#to compare total program attendance across communities
kruskal.test(Prog_attend~Majority_demo, lib_2012_services)

#to compare total reference transactions across communities
kruskal.test(Reference~Majority_demo, lib_2012_services)
with(lib_2012_services, dunn.test(Reference, Majority_demo, kw=F, method="bonferroni"))

#to compare total uses of public internet computers across communities
kruskal.test(Pub_Internet~Majority_demo, lib_2012_services)
with(lib_2012_services, dunn.test(Pub_Internet, Majority_demo, kw=F, method="bonferroni"))
```
Libraries located in communities with a majority of White members had a higher mean rank in the number of circulation transactions (*M* = 272.51) than those located in communities with a majority of Black members (*M* = 181.79) and Hispanic members (*M* = 161.93). With regards to the number of reference transactions, libraries located in communities with majority Black members (*M* = 321.25) had higher mean rank than those located in communities with a majority of White (*M* = 229.45) and Hispanic (*M* = 260.07) members. With regards to use of public internet computers, communities with a majority of Hispanic (*M* = 301.10) and Black (*M* = 309.63) had higher mean ranks than those located in communities with a majority of White members (*M* = 223.71). Finally, program attendance did not differ across the three different communities.

To graph this:
```{r Services graph, echo=F, fig.align='center', dpi=500}
lib_2012_services_sum<-lib_2012_services %>%
  group_by(Majority_demo) %>%
  summarise(Cir_mean=mean(Cir, na.rm=T), Cir_SD=sd(Cir, na.rm=T), 
            Cir_SE=sd(Cir, na.rm=T)/sqrt(sum(!is.na(Cir))),
            
            Prog_mean=mean(Prog_attend, na.rm=T), Prog_SD=sd(Prog_attend, na.rm=T), 
            Prog_SE=sd(Prog_attend, na.rm=T)/sqrt(sum(!is.na(Prog_attend))),
            
            Ref_mean=mean(Reference, na.rm=T), Refer_SD=sd(Reference, na.rm=T), 
            Ref_SE=sd(Reference, na.rm=T)/sqrt(sum(!is.na(Reference))),
            
            Int_mean=mean(Pub_Internet, na.rm=T), Int_SD=sd(Pub_Internet, na.rm=T), 
            Int_SE=sd(Pub_Internet, na.rm=T)/sqrt(sum(!is.na(Pub_Internet)))
  )


lib_2012_services_mean<-melt(lib_2012_services_sum[,c("Majority_demo", "Cir_mean", "Prog_mean", "Ref_mean", "Int_mean")], id.vars = "Majority_demo", variable.name = "Service")
names(lib_2012_services_mean)[3]<-"Mean"

lib_2012_services_se<-melt(lib_2012_services_sum[,c("Majority_demo", "Cir_SE", "Prog_SE", "Ref_SE", "Int_SE")], id.vars = "Majority_demo", variable.name = "Service") 

lib_2012_services_mean$SE<-lib_2012_services_se[,3]

service_title<-"Use of library services varies based on its community's racial/ethnic demographics"
service_title<-paste0(strwrap(service_title, 75), sep="", collapse="\n")

service_caption<-"Note: There was a larger number of circulation transactions in libraries located in communities with majority White members compared to those located in majority Black and Hispanic communities. The latter two communities, on the other hand, made more use of libraries' public internet computers. Libraries located in communities with a majority of Black members also made more reference transactions compared to the other two communities. Finally, the three communities did not differ in their attendance to programs offered by libraries."

service_caption<-paste0(strwrap(service_caption, 110), sep="", collapse="\n")

lib_2012_services_mean %>%
  ggplot(aes(x=Majority_demo, y=Mean, fill=Majority_demo))+
  geom_bar(stat="identity", position="dodge", aes(alpha=Service)) +
  scale_fill_manual(values=cbPalette)+
  scale_alpha_manual(values=c(0.30, 0.5, 0.75, 1), name="Service Type", labels=c("Circulation", "Programs", "References", "Public Internet Computers")) +
  geom_errorbar(aes(ymin=Mean-SE, ymax=Mean+SE, group=Service), width=.2, position=position_dodge(.9)) +
  labs(x="Race/Ethnicity",
       y="Average Use of Service Type per Visit", 
       title=service_title,
       caption=service_caption)+
  theme_bw() +
  theme(plot.title=element_text(size = 13, face = "bold"),
        plot.caption = element_text(size=9, hjust=0)) +
  guides(fill=FALSE)+
  ylim(0,2.0)+
  geom_text(
    aes(label = round(Mean, 3), group=Service, y=Mean+SE/1.8), 
    vjust=-1.5,
    position = position_dodge(0.90),
    size=2.5, colour="black", show.legend = F)
```